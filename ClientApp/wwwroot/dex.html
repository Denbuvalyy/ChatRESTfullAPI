<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Client App</title>
    <script src="lib/query/jquery.min.js"></script>
</head>
<body>
    <div style="padding:5px;">
        <h3>Happy chats</h3>
        <div style="width:30%;float:left">
            <select id="mySelect"></select>
        </div>
        <div style="width:30%;float:left;padding:5px;">
            <label style="position:relative">Chat users:</label>
            <div id="chatUsersField" style="width:100px;height:150px;overflow:auto;"></div>
            <!--<textarea id="ChatUserfield" style="width:90px;height:100px;"></textarea>-->
            <!--<div id="userCreation">
                <input type="text" name="userName" id="userName" placeholder="User name" />
                <button type="button" id="userCreate" onclick="UserCreate();" style="margin:5px;">Create User</button>
            </div>-->
            <button id="chatJoin" title="Join current chat" onclick="ChatJoin();" style="display:none;">Join chat</button>
            <button onclick="setdata()">Create chat</button>
       
        </div>
        <div style="width:40%;float:left">
            <label style="position:relative">Chat messages:</label>
            <div id="messagefield" style="width:550px;height:300px;padding:3px;overflow:auto;border:1px solid grey"></div>
            <!--<textarea id="messagefield" style="width:550px;height:300px;padding:3px;"></textarea>-->
        </div>
    </div>

    <pre id="preOutput"></pre>





    <script>
        var crntChatId;
        var crntUser;
        var chatMessages;
        var users;

        var np = document.createElement("p");
        //np.innerHTML = "User: "+"<b>"+"Default user"+"</b>";
        np.id = "hp";
        var div = document.createElement("div");
        div.appendChild(np);
        document.body.appendChild(div);
        var usrtxt = document.createElement("textarea");
        usrtxt.style.width = "200px";
        usrtxt.style.height = "50px";
        usrtxt.style.overflow = "auto";
        usrtxt.id = "usrTxt";
        div.appendChild(usrtxt);
        var btnSend = document.createElement("button");
        var descrp = document.createTextNode("Send");
        btnSend.appendChild(descrp);
        btnSend.id = "sendBtn";
        btnSend.style.display = "none";
        div.appendChild(btnSend);

        $(document).ready(function () {
            $.getJSON('https://localhost:44367/api/chats/', function (object) {

                //chatMessages = object;

                for (i = 0; i < object.length; i++) {

                    var z = document.createElement("option");
                    z.setAttribute("value", object[i].chatId);
                    var t = document.createTextNode(object[i].chatName);
                    z.appendChild(t);
                    document.getElementById("mySelect").appendChild(z);
                }               
            });
            UserCreate();
        });
        function start() {
            document.getElementById("mySelect").addEventListener("change", addActivityItem, false);
        }
        //document.getElementById("mySelect").options.selectedIndex = 1;

        function addActivityItem() {

            //option is selected
            crntChatId = document.getElementById("mySelect").value;



            //var messages = chatMessages[id - 1].chatMessages;
            //document.getElementById("ChatUserfield").innerHTML = '';

            //ShowUsers();

           // ShowMessages();
            $("#sendBtn").css("display", "block");
        }
            
            $("#sendBtn").click(function () {
                if ($("#usrTxt").val() == "") { alert("Message can't be blank!"); }
                else {
                    //        var user = { username: usrname, usermessages: null, userchats: null };
                    
                    var userMessage = { body: $("#usrTxt").val(), creationTime: new Date(), chatId: crntChatId, userId: crntUser.userId };
                    $.ajax({
                        type: "PUT",
                        data: JSON.stringify(userMessage),
                        url: "https://localhost:44367/api/chats/" + crntChatId,
                        crossDomain: true,
                        contentType: "application/json",
                        success: function (data) {
                            //$("#result").data($data);                          

                        }
                    });
                    $("#usrTxt").val("");
                    //alert("Proceeding 'Send' click.");
                  
                }
                //ShowMessages();
            });
           
        
       
        window.addEventListener("load", start, false);

        function UserCreate() {

            var user = { username: "Default user", usermessages: null, userchats: null };

            $.ajax({
                type: "POST",
                data: JSON.stringify(user),
                url: "https://localhost:44367/api/users",
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    //$("#result").data($data);
                    crntUser = data;
                    $("#hp").html("User: " + "<b>" + crntUser.userName + "</b>");

                }
            });
        }
        //                $("#userCreation").css("display", "none");
        //                var usrtxt = document.createElement("textarea");
        //                usrtxt.style.width = "200px";
        //                usrtxt.style.height = "50px";
        //                usrtxt.style.overflow = "auto";
        //                div.appendChild(usrtxt);
        //                var btnSend = document.createElement("button");
        //                var descrp = document.createTextNode("Send");
        //                btnSend.appendChild(descrp);
        //                div.appendChild(btnSend);
        //            }
        //        });
        //    }
        //    else alert("You have to enter user name!");


        //}

      

       
        //    $.ajax({
        //        type: 'GET',
        //        url: '/functions.php',
        //        data: { get_param: 'value' },
        //        success: function (data) {
        //            for (var i = 0; i < data.length; ++i) {
        //                $('#cand').append('<div class="name">data[i].name</>');
        //            }
        //        }
        //    });
        //};

        function setdata() {
            var chat = { chatname: "Fresh one", chatmessages: null, chatusers: null };
            $.ajax({
                type: "POST",
                data: JSON.stringify(chat),
                url: "https://localhost:44367/api/chats",
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {

                    //$("#result").data($data);
                    chatId = data.chatId;
                    alert("chat id is:" + chatId);
                    $("#userName").val(chatId);
                    
                }
            });
           
        }

        //function ShowUsers() {
        //    document.getElementById("chatUsersField").innerHTML = '';

        //    var url = 'https://localhost:44367/api/chats/' + crntChatId + '/users';
        //    //$.getJSON(url, function (obje) {

        //    //    users = obje;
        //    //    for (i = 0; i < users.length; i++) {
        //    //        //var t = document.createTextNode(users[i].userName + "\n");

        //    //        var par = document.createElement("span");
        //    //        par.innerHTML = users[i].userName;
        //    //        par.innerText += "\n";
        //    //        par.style.fontStyle = "italic";
        //    //        par.style.color = "red";
        //    //        //par.id = "par" + i;
        //    //        document.getElementById("chatUsersField").appendChild(par);
        //    //        //$("#par" + i).click(function () { alert("User name with id= " + i + " clicked"); });
        //    //        //document.getElementById("ChatUserfield").appendChild(t);
        //    //    }
        //    //});

        //    $.ajax({
        //        type: "GET",
        //        url: url,
        //        crossDomain: true,
        //        contentType: "application/json",
        //        success: function (data) {

        //            //$("#result").data($data);
        //               users = obje;
        //          for (i = 0; i < users.length; i++) {
        //            //var t = document.createTextNode(users[i].userName + "\n");

        //            var par = document.createElement("span");
        //            par.innerHTML = users[i].userName;
        //            par.innerText += "\n";
        //            par.style.fontStyle = "italic";
        //            par.style.color = "red";
        //            //par.id = "par" + i;
        //            document.getElementById("chatUsersField").appendChild(par);
        //            //$("#par" + i).click(function () { alert("User name with id= " + i + " clicked"); });
        //            //document.getElementById("ChatUserfield").appendChild(t);
        //          }

        //        }
        //    });

        //        //$.ajax({
        //        //    type: 'GET',
        //        //    url: url,                    
        //        //    //data: { get_param: 'users' },
        //        //    success: function (data) {
        //        //        users = data;

        //        //        for (i = 0; i < users.length; i++) {
        //        //    //var t = document.createTextNode(users[i].userName + "\n");

        //        //        var par = document.createElement("span");
        //        //        par.innerHTML = users[i].userName;
        //        //        par.innerText += "\n";
        //        //        par.style.fontStyle = "italic";
        //        //        par.style.color = "red";
        //        //    //par.id = "par" + i;
        //        //        document.getElementById("chatUsersField").appendChild(par);
        //        //    //$("#par" + i).click(function () { alert("User name with id= " + i + " clicked"); });
        //        //    //document.getElementById("ChatUserfield").appendChild(t);
        //        //        }

        //        //    }
        //        //});

           


        //}

        //function ShowMessages() {
        //    document.getElementById("messagefield").innerHTML = '';

        //    var url = 'https://localhost:44367/api/chats/' + crntChatId + '/messages/';
        //    $.getJSON(url, function (object) {

        //        chatMessages = object;


        //        for (j = 0; j < chatMessages.length; j++) {
        //            for (i = 0; i < users.length; i++) {
        //                if (chatMessages[j].userId == users[i].userId) {

        //                    var par = document.createElement("span");
        //                    par.innerText = users[i].userName + ": ";

        //                    par.style.color = "red";
        //                    document.getElementById("messagefield").appendChild(par);
        //                    par = document.createElement("span");
        //                    par.innerText = "   " + chatMessages[j].body + "\n";// + "  --" + messages[j].creationTime + "\n";
        //                    par.style.fontStyle = "italic";
        //                    document.getElementById("messagefield").appendChild(par);


        //                    //par = document.createElement("span");
        //                    //par.innerText = "time \n";
        //                    //par.style.cssFloat = "right";
        //                    //document.getElementById("messagefield").appendChild(par);

        //                }
        //            }
        //        }

        //    });
        //}

    </script>
</body>
</html>
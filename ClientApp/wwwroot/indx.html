<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="favicon.ico">
    <link href="./css/Layout.css" rel="stylesheet" />
    <meta charset="utf-8" />
    <title>Client App</title>
    <script src="lib/query/jquery.min.js"></script>
</head>
<body>
    <div class="left ss-item-required" id="loginform" style="margin:10px;padding:10px;width:80vw;height:500px;overflow:auto; border:2px solid black;">
        Login:
        <input id="login0" placeholder="login" />
        <br /><br />
        Password:
        <input  id="login1" placeholder="password"/>
        <br /><br />
        <button onclick="LoginUser();">Submit</button>
        <button onclick="RegisterUser();">Register</button>
    </div>
    <div class="ss-item-required" id="regform" style="margin:10px;padding:10px;width:80vw;height:500px;overflow:auto; border:2px solid black;display:none;">
        <h4>Registration</h4>
        Email:
        <input id="field0" name="email" placeholder="email" />
        <br /><br />
        Login:
        <input id="field1" name="login" placeholder="login" />
        <br /><br />
        Password:
        <input id="field2" name="password" placeholder="password" />
        <br /><br />
        Password:
        <input id="field3" name="password" placeholder="retype password" />
        <br /><br />
        <button onclick="SubmitForm();">Register</button>
    </div>
    <div id="mainform" style="display:none;">
        <div style="overflow:auto;">
            <div class="left">
                <button onclick="setdata()">Create chat</button>
                <select id="mySelect" autofocus onchange="ChooseOption(this.value);"></select>
            </div>


        </div>

        <div style="overflow:auto;">
            <div class="main">
                <label style="position:relative">Chat users:</label>
                <div>
                    <ul class="demo" id="user_popup">
                        <li id="msgheadUP" class="msheader" style="color:white;background-color:Highlight;margin-top:0px;"></li>
                        <li onclick="StartPrivateChat(crntMess, crntUser);">start a private chat</li>
                        <li onclick="HidePopup('user_popup');">cancel</li>
                    </ul>
                </div>
                <div id="chatUsersField"></div>

                <button id="chatJoin" title="Join current chat" onclick="ChatJoin();" style="display:none;">Join chat</button>

            </div>
            <div class="bottom">
                <label style="position:relative;">Chat messages:</label>
                <hr />
                <div>
                    <ul class="demo" id="mine_popup">
                        <li id="msghead" class="msheader" style="color:white;background-color:Highlight;margin-top:0px;"></li>
                        <li onclick="MsgDeleteOne(crntMess);">delete for myself</li>
                        <li onclick="MsgDelete();">delete for everyone</li>
                        <li onclick="MsgEdit()">edit</li>
                        <li onclick="HidePopup('mine_popup');">cancel</li>
                    </ul>
                </div>
                <div>
                    <ul class="demo" id="mine_popupPrvt">
                        <li id="msgheadPrvt" class="msheader" style="color:white;background-color:Highlight;margin-top:0px;"></li>
                        <li onclick="Reply(crntMess, crntUser);">reply</li>
                        <li onclick="ReplyPerson(crntMess, crntUser);">reply to sender personaly</li>
                        <li onclick="StartPrivateChat(crntMess, crntUser);">start a private chat</li>
                        <li onclick="HidePopup('mine_popupPrvt');">cancel</li>
                    </ul>
                </div>
                <div id="messagefield"></div>
            </div>

        </div>
        <div class="left" id="usermsg" style="display:none;">
            <p id="hp"></p>
            <textarea id="usrTxt" style="width:300px;height:50px;overflow:auto;"></textarea>
            <button id="sendBtn" style="display:none;margin-left:70px;">Send</button>
            <button id="updateMsg" style="display:none;margin-left:70px;">Ok</button>
        </div>
    </div>
    <!--
    <div style="padding:5px;">
        <h3>Happy chats</h3>
        <div style="width:30%;float:left">
            <select id="mySelect" autofocus onchange="ChooseOption(this.value);"></select>
        </div>
        <div style="width:30%;float:left;padding:5px;">
            <label style="position:relative">Chat users:</label>
            <div id="chatUsersField" style="width:100px;height:150px;overflow:auto;"></div>

            <button id="chatJoin" title="Join current chat" onclick="ChatJoin();" style="display:none;">Join chat</button>
            <button onclick="setdata()">Create chat</button>

        </div>
        <div style="width:40%;float:left">
            <label style="position:relative">Chat messages:</label>
            <div id="messagefield" style="width:550px;height:300px;padding:3px;overflow:auto;border:1px solid grey"></div>
        </div>
    </div>
        -->

    <pre id="preOutput"></pre>





    <script>
        const base_url = "https://localhost:44367/api/";
        var chats;
        var crntChatId;
        var crntUser;
        var chatMessages;
        var users;
        var crntUserId;
        var crntMess;
        /*var np = document.createElement("p");
        np.id = "hp";
        var div = document.createElement("div");
        div.appendChild(np);
        //document.body.appendChild(div);
        var usrtxt = document.createElement("textarea");
        usrtxt.style.width = "auto";
        usrtxt.style.height = "50px";
        usrtxt.style.overflow = "auto";
        usrtxt.id = "usrTxt";
        div.appendChild(usrtxt);
        var btnSend = document.createElement("button");
        var descrp = document.createTextNode("Send");
        btnSend.appendChild(descrp);
        btnSend.id = "sendBtn";
        btnSend.style.display = "none";
        div.appendChild(btnSend);
        document.getElementById("usermsg").appendChild(div);
        */
        document.getElementById("mine_popup").onmouseleave = function () {
            document.getElementById("mine_popup").style.display = "none";
        };
        document.getElementById("mine_popupPrvt").onmouseleave = function () {
            document.getElementById("mine_popupPrvt").style.display = "none";
        };
        document.getElementById("user_popup").onmouseleave = function () {
            document.getElementById("user_popup").style.display = "none";
        };
        document.getElementById("regform").onmouseleave = function () {
            document.getElementById("regform").style.display = "none";
            document.getElementById("mainform").style.display = "block";
        };

        //$(document).ready(function () {
        //    $.getJSON(base_url + 'chats/', function (object) {

        //        chats = object;
        //        for (i = 0; i < object.length; i++) {

        //            var z = document.createElement("option");
        //            z.setAttribute("value", object[i].chatId);
        //            var t = document.createTextNode(object[i].chatName);
        //            z.appendChild(t);
        //            document.getElementById("mySelect").appendChild(z);
        //        }
        //        document.getElementById("mySelect").options[0].selected = true;
        //        document.getElementById("mySelect").onchange();
        //    });

        //    UserCreate();

        //});



        function ChooseOption(selValue) {
            crntChatId = selValue;

            ShowUsers();

            $("#sendBtn").css("display", "block");
        }

        $("#sendBtn").click(function () {
            if ($("#usrTxt").val() == "") { alert("Message can't be blank!"); }
            else {

                var userMessage = { body: $("#usrTxt").val(), creationTime: new Date(), chatId: crntChatId, userId: crntUser.userId };
                $.ajax({
                    type: "PUT",
                    data: JSON.stringify(userMessage),
                    url: base_url + "chats/" + crntChatId,
                    crossDomain: true,
                    contentType: "application/json",
                    success: function (data) {
                        $("#usrTxt").val("");
                        ShowUsers();

                    }
                });

            }

        });




        //function UserCreate() {

        //    var user = { username: "Default user", usermessages: null, userchats: null };

        //    $.ajax({
        //        type: "POST",
        //        data: JSON.stringify(user),
        //        url: base_url + "users",
        //        crossDomain: true,
        //        contentType: "application/json",
        //        success: function (data) {
        //            crntUser = data;
        //            $("#hp").html("User: " + "<b>" + crntUser.userName + "</b>");

        //        }
        //    });
        //}


        function StartPrivateChat(crntMess, crntUser) {

            var scndUser;

            for (var i = 0; i < users.length; i++) {
                if (users[i].userId == crntMess.userId) {
                    scndUser = users[i];
                    break;
                }
            }

            var chatUsers = [{ "userId": crntUser.userId, "user": crntUser },
            { "userId": scndUser.userId, "user": scndUser }];
            var chat = {
                chatname: scndUser.userName + "&" + crntUser.userName, chatmessages: null,
                chatusers: chatUsers
            };
            $.ajax({
                type: "POST",
                data: JSON.stringify(chat),
                url: base_url + "chats",
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    document.getElementById("mySelect").options[chats.length - 1].selected = true;
                    document.getElementById("mySelect").onchange();
                    $("#usrTxt").focus();
                    //chatId = data.chatId;
                    //alert("chat id is:" + chatId);
                    //$("#userName").val(chatId);

                }
            });

        }

        function ShowUsers() {
            document.getElementById("chatUsersField").innerHTML = '';

            var url = base_url + 'chats/' + crntChatId + '/users';
            $.get(url, function (object) {
                users = object;

                for (i = 0; i < object.length; i++) {
                    if (object[i].userId == crntUser.userId) {
                        crntUser = object[i];
                    }
                    var par = document.createElement("span");
                    par.innerHTML = object[i].userName;
                    par.innerText += "\n";
                    par.title = "To start a chat with the user click on them.";
                    par.style.fontStyle = "italic";
                    par.style.color = "red";
                    par.id = object[i].userId;
                    par.addEventListener("click", function () {
                        document.getElementById("msgheadUP").innerHTML = this.innerHTML.substr(0, 15);
                        document.getElementById("user_popup").style.display = "block";
                        //if (confirm("You about to start a private chat.")) {
                        //    document.getElementById("messagefield").innerHTML = '';

                        //}
                        //alert("User name with id= " + this.id + " clicked");
                        crntUserId = this.id;


                    });
                    document.getElementById("chatUsersField").appendChild(par);

                }
                //GetCrntUser(crntUser.userId);
                ShowMessages();

            });

        }

        function ShowChats() {
            $.getJSON(base_url + 'chats/', function (object) {

                chats = object;
                for (i = 0; i < object.length; i++) {

                    var z = document.createElement("option");
                    z.setAttribute("value", object[i].chatId);
                    var t = document.createTextNode(object[i].chatName);
                    z.appendChild(t);
                    document.getElementById("mySelect").appendChild(z);
                }
                document.getElementById("mySelect").options[0].selected = true;
                document.getElementById("mySelect").onchange();
            });
        }

        function ShowMessages() {

            document.getElementById("messagefield").innerHTML = '';

            var url = base_url + 'chats/' + crntChatId + '/messages/';
            $.getJSON(url, function (object) {

                chatMessages = object;

                var j, i;
                for (j = 0; j < chatMessages.length; j++) {
                    for (i = 0; i < users.length; i++) {
                        if (chatMessages[j].userId == users[i].userId) {
                            if ((chatMessages[j].userId == crntUser.userId) && (chatMessages[j].userNotVisible == true)) {//!MsgExist(chatMessages[j].msgId)) {
                                continue;
                            }

                            var par = document.createElement("span");
                            par.innerText = users[i].userName + ": ";

                            par.style.color = "red";
                            document.getElementById("messagefield").appendChild(par);
                            par = document.createElement("span");
                            par.innerText = "   " + chatMessages[j].body + "\n";
                            par.style.fontStyle = "italic";
                            par.id = chatMessages[j].msgId;
                            par.addEventListener("click", function () {
                                var crntMsg;
                                for (j = 0; j < chatMessages.length; j++) {
                                    if (chatMessages[j].msgId == this.id) {
                                        crntMsg = chatMessages[j];
                                        break;
                                    }
                                }
                                if (crntMsg.userId == crntUser.userId) {
                                    document.getElementById("msghead").innerHTML = crntMsg.body.substr(0, 15) + "...";
                                    document.getElementById("mine_popup").style.display = "block";
                                    crntMess = crntMsg;
                                }

                                else {
                                    document.getElementById("msgheadPrvt").innerHTML = crntMsg.body.substr(0, 15) + "...";
                                    document.getElementById("mine_popupPrvt").style.display = "block";
                                    crntMess = crntMsg;
                                }

                            });
                            document.getElementById("messagefield").appendChild(par);
                        }
                    }
                }
            });
        }

        function MsgDelete() {
            document.getElementById("mine_popup").style.display = "none";

            $.ajax({
                type: "DELETE",
                url: base_url + "Messages/" + crntMess.msgId,
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    ShowUsers();
                }
            });
        }

        function MsgEdit() {
            document.getElementById("mine_popup").style.display = "none";
            document.getElementById("usrTxt").value = crntMess.body;
            $("#sendBtn").css("display", "none");
            document.getElementById("updateMsg").style.display = "block";
        }

        $("#updateMsg").click(function () {
            crntMess.body = $("#usrTxt").val();
            $.ajax({
                type: "PUT",
                data: JSON.stringify(crntMess),
                url: base_url + "Messages/" + crntMess.msgId,
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    ShowUsers();
                }
            });
            $("#sendBtn").css("display", "block");
            document.getElementById("updateMsg").style.display = "none";
            $("#usrTxt").val("");
        });

        //function MsgExist(msgId) {
        //    var Msexist = false;
        //    if (crntUser.userMessages != null) {
        //        var msglist = crntUser.userMessages;
        //        for (i = 0; i < msglist.length; i++) {
        //            if (msglist[i].msgId == msgId) {
        //                Msexist = true;
        //                break;
        //            }
        //        }
        //    }
        //    return Msexist;
        //}

        //function GetCrntUser(userId) {
        //    var user;
        //    var url = 'https://localhost:44367/api/Users/' + userId;

        //    $.get(url, function (object) {
        //        user = object;
        //    });
        //    //$.ajax({
        //    //    type: "GET",
        //    //    url: url,
        //    //    crossDomain: true,
        //    //    contentType: "application/json",
        //    //    success: function (data) {
        //    //        user = data;

        //    //    }
        //    //});
        //    return user;
        //}

        function MsgDeleteOne(CrntMsg) {
            document.getElementById("mine_popup").style.display = "none";

            CrntMsg.UserNotVisible = true;

            $.ajax({
                type: "PUT",
                data: JSON.stringify(CrntMsg),
                url: base_url + "Messages/" + CrntMsg.msgId,
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    ShowUsers();
                }
            });

        }

        function HidePopup(id) {
            document.getElementById(id).style.display = "none";
        }

        function ReplyPerson(crntMess, crntUser) {

        }

        function RegisterUser() {
            document.getElementById("regform").style.display = "block";
            document.getElementById("mainform").style.display = "none";

        }

        function SubmitForm() {
            //alert("SubmitForm here!");
            var fields = $(".ss-item-required")
                .find("select, textarea, input").serializeArray();
            var fire = true;

            $.each(fields, function (i, field) {
                if (!field.value) {
                    alert(field.name + ' is required');
                    fire = false;
                }
            });
            console.log(fields);
            if (fire) {
                $.each(fields, function (i, field) {
                    //alert(field.name + " " + field.value + i);
                    //document.getElementsByName(field.name).innerText = " ";
                    document.getElementById("field" + i).value = " ";
                });
            }
        }

        function LoginUser() {
            var fields = $(".ss-item-required")
                .find("select, textarea, input").serializeArray();
            var fire = true;

            $.each(fields, function (i, field) {
                if (!field.value) {
                    alert(field.name + ' is required');
                    fire = false;
                }
            });
            console.log(fields);
            if (fire) {
                var url = base_url + 'users/' + fields[0];
                var tempuser;
                $.get(url, function (object) {
                    tempuser = object;
                });
                if (tempuser.Password == fields[1]) {
                    document.getElementById("mainform").style.display = "block";
                    crntUser = tempuser;
                    $("#hp").html("User: " + "<b>" + crntUser.userName + "</b>");
                    $.each(fields, function (i, field) {
                        //alert(field.name + " " + field.value + i);
                        //document.getElementsByName(field.name).innerText = " ";
                        document.getElementById("field" + i).value = " ";
                    });
                    document.getElementById("loginform").style.display = "none";
                    ShowChats();
                }                
            }
        }
    </script>
</body>
</html>
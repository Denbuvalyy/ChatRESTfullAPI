<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="favicon.ico">
    <link href="./css/Layout.css" rel="stylesheet" />
    <meta charset="utf-8" />
    <title>Client App</title>
    <script src="lib/query/jquery.min.js"></script>
</head>
<body>
    <fieldset id="loginform">

        <legend>Login to chats</legend>
        <div class="left" style="margin:10px;padding:10px;width:80vw;height:500px;overflow:auto;">
            Email:
            <input id="login0" name="email" placeholder="email" />
            <br /><br />
            Password:
            <input id="login1" name="password" placeholder="password" />
            <br /><br />
            <button onclick="LoginUser();">Login</button>&nbsp;&nbsp;
            <button onclick="ShowRegistration();">Register</button>
        </div>
    </fieldset>
    <fieldset id="regform" style="display:none;">
        <legend>Registration to chats</legend>
        <div class="ss-item-required" style="margin:10px;padding:10px;width:80vw;height:500px;overflow:auto;">
            Name:
            <input id="field0" name="name" placeholder="name" />
            <br /><br />

            Email:
            <input id="field1" name="email" placeholder="email" />
            <br /><br />

            Password:
            <input id="field2" name="password" placeholder="password" />
            <br /><br />

            Password:
            <input id="field3" name="password" placeholder="retype password" />
            <br /><br />
            <button onclick="SubmitForm();">Register</button>&nbsp;&nbsp;
            <button onclick="LeaveRegistration();">Cancel</button>
        </div>
    </fieldset>

    <div id="mainform" style="display:none;">
        <div style="overflow:auto;">
            <div class="left">
                <button onclick="setdata()">Create chat</button>
                <select id="ChatSelect" autofocus onchange="ChooseOption(this.value);"></select>
            </div>


        </div>

        <div style="overflow:auto;">
            <div class="main">
                <label style="position:relative">Chat users:</label>
                <div>
                    <ul class="demo" id="user_popup">
                        <li id="msgheadUP" class="msheader" style="color:white;background-color:Highlight;margin-top:0px;"></li>
                        <li onclick="StartPrivateChat(crntMess, crntUser);">start a private chat</li>
                        <li onclick="HidePopup('user_popup');">cancel</li>
                    </ul>
                </div>
                <div id="chatUsersField"></div>

                <button id="chatJoin" title="Join current chat" onclick="ChatJoin();" style="display:none;">Join chat</button>

            </div>
            <div class="bottom">
                <label style="position:relative;">Chat messages:</label>
                <hr />
                <div>
                    <ul class="demo" id="mine_popup">
                        <li id="msghead" class="msheader" style="color:white;background-color:Highlight;margin-top:0px;"></li>
                        <li onclick="MsgDeleteOne(crntMess);">delete for myself</li>
                        <li onclick="MsgDelete();">delete for everyone</li>
                        <li onclick="MsgEdit()">edit</li>
                        <li onclick="HidePopup('mine_popup');">cancel</li>
                    </ul>
                </div>
                <div>
                    <ul class="demo" id="mine_popupPrvt">
                        <li id="msgheadPrvt" class="msheader" style="color:white;background-color:Highlight;margin-top:0px;"></li>
                        <li onclick="PublicReply(crntMess, crntUser);">reply</li>
                        <li onclick="ReplyPerson(crntMess, crntUser);">reply to sender personaly</li>
                        <li onclick="StartPrivateChat(crntMess, crntUser);">start a private chat</li>
                        <li onclick="HidePopup('mine_popupPrvt');">cancel</li>
                    </ul>
                </div>
                <div id="messagefield"></div>
            </div>

        </div>
        <div class="left" id="usermsg">
            <div style="float:left;">
                <p id="hp"></p>
                <button id="logout" onclick="LogOut();">Log out</button>
            </div>
            <div style="display:inline-block;">
                <div id="MsgFld" style="border:1px solid blue;border-radius:50px 20px;display:none;margin:5px; padding:10px;background-color:lightgray;"></div>
                <textarea id="usrTxt" style="width:300px;height:50px;overflow:auto;"></textarea>
            </div>
            <div>
                <button id="PrsnlRplBtn" onclick="PersonalReply(crntUser)" style="display:none;">Reply</button>
                <button id="CancelRplBtn" onclick="ReplyCancel();"style="display:none;">Cancel</button>
                <button id="sendBtn" style="display:none;margin-left:70px;">Send</button>
                <button id="updateMsg" style="display:none;margin-left:70px;">Ok</button>
            </div>
        </div>
    </div>
   

    <pre id="preOutput"></pre>





    <script>
        const base_url = "https://localhost:44367/api/";
        var chats;
        var crntChatId;
        var crntUser;
        var chatMessages;
        var users;
        var crntUserId;
        var crntMess;
        var scndUser=0;

      
        document.getElementById("mine_popup").onmouseleave = function () {
            document.getElementById("mine_popup").style.display = "none";
        };
        document.getElementById("mine_popupPrvt").onmouseleave = function () {
            document.getElementById("mine_popupPrvt").style.display = "none";
        };
        document.getElementById("user_popup").onmouseleave = function () {
            document.getElementById("user_popup").style.display = "none";
        };
        

        function ChooseOption(selValue) {
            crntChatId = selValue;

            ShowUsers();

            $("#sendBtn").css("display", "block");
        }


        $("#sendBtn").click(function () {
            if ($("#usrTxt").val() == "") { alert("Message can't be blank!"); }
            else {

                var userMessage = { body: $("#usrTxt").val(), creationTime: new Date(), chatId: crntChatId, userId: crntUser.userId };
                $.ajax({
                    type: "PUT",
                    data: JSON.stringify(userMessage),
                    url: base_url + "chats/" + crntChatId,
                    crossDomain: true,
                    contentType: "application/json",
                    success: function (data) {
                        $("#usrTxt").val("");
                        ShowUsers();
                    }
                });
            }
        });       


        function StartPrivateChat(crntMess, crntUser) {

            for (var i = 0; i < users.length; i++) {
                if (users[i].userId == crntMess.userId) {
                    scndUser = users[i];
                    break;
                }
            }

            var chatUsers = [{ "userId": crntUser.userId, "user": crntUser },
            { "userId": scndUser.userId, "user": scndUser }];
            var chat = {
                chatname: scndUser.userName + "&" + crntUser.userName, chatmessages: null,
                chatusers: chatUsers, private: true
            };
            $.ajax({
                type: "POST",
                data: JSON.stringify(chat),
                url: base_url + "chats",
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    document.getElementById('mine_popupPrvt').style.display = "none";
                    ShowChats(chats.length);                    
                    $("#usrTxt").focus();                    
                }
            });
        }


        function ShowUsers() {
            document.getElementById("chatUsersField").innerHTML = '';

            var url = base_url + 'chats/' + crntChatId + '/users';
            $.get(url, function (object) {
                users = object;

                for (i = 0; i < object.length; i++) {
                    if (object[i].userId == crntUser.userId) {
                        crntUser = object[i];
                    }
                    var par = document.createElement("span");
                    par.innerHTML = object[i].userName;
                    par.innerText += "\n";
                    par.title = "To start a chat with the user click on them.";
                    par.style.fontStyle = "italic";
                    par.style.color = "red";
                    par.id = object[i].userId;
                    par.addEventListener("click", function () {
                        document.getElementById("msgheadUP").innerHTML = this.innerHTML.substr(0, 15);
                        document.getElementById("user_popup").style.display = "block";
                       
                        crntUserId = this.id;

                    });
                    document.getElementById("chatUsersField").appendChild(par);
                }
                //var myVar = setInterval(ShowMessages, 5000);

                ShowMessages();
            });
        }


        function ShowChats(index = 0) {
            $("#ChatSelect").empty();
            $.getJSON(base_url + 'chats/', function (object) {
                var textcolor = "black";
                chats = object;
                for (i = 0; i < object.length; i++) {
                    if (object[i].private) {
                        if (object[i].chatUsers[0].userId != crntUser.userId && object[i].chatUsers[1].userId != scndUser.userId) {
                            continue;
                        }
                        else {
                            textcolor = "blue";
                        }
                    }
                    else {
                        textcolor = "black";
                    }
                    var option = document.createElement("option");
                    option.setAttribute("value", object[i].chatId);
                    var opttext = document.createTextNode(object[i].chatName);
                    option.appendChild(opttext);
                    document.getElementById("ChatSelect").appendChild(option);
                    document.getElementById("ChatSelect").options[document.getElementById("ChatSelect").length - 1].style.color=textcolor;

                }

                if (index != 0) {
                    index = document.getElementById("ChatSelect").length - 1;
                }
                document.getElementById("ChatSelect").options[index].selected = true;
                document.getElementById("ChatSelect").onchange();
            });
        }


        function ShowMessages() {

            document.getElementById("messagefield").innerHTML = '';

            var url = base_url + 'chats/' + crntChatId + '/messages/';
            $.getJSON(url, function (object) {

                chatMessages = object;

                var j, i;
                for (j = 0; j < chatMessages.length; j++) {
                    for (i = 0; i < users.length; i++) {
                        if (chatMessages[j].userId == users[i].userId) {
                            if ((chatMessages[j].userId == crntUser.userId) && (chatMessages[j].userNotVisible == true)) {
                                continue;
                            }

                            var MsgFld = document.createElement("div");
                            MsgFld.classList.add('publicMsgs');

                            let MsgBody = chatMessages[j].body;
                            if (chatMessages[j].isReply) {
                                var replFld = document.createElement("div");
                                replFld.classList.add("replyMsgHead");
                                replFld.innerHTML = MsgBody.substr(0, 23);
                                MsgBody = MsgBody.substr(23);
                                MsgFld.appendChild(replFld);
                            }

                            var par = document.createElement("span");
                            par.innerText = users[i].userName + ": ";

                            par.style.color = "red";

                            
                            MsgFld.appendChild(par);
                            if (chatMessages[j].userId == crntUser.userId) {
                                MsgFld.classList.add("personalMsgs");
                            }
                            //document.getElementById("messagefield").appendChild(par);
                            par = document.createElement("span");
                            par.innerText = "   " + MsgBody + "\n";
                            par.style.fontStyle = "italic";
                            MsgFld.id = chatMessages[j].msgId;
                            MsgFld.addEventListener("click", function () {
                                var crntMsg;
                                for (j = 0; j < chatMessages.length; j++) {
                                    if (chatMessages[j].msgId == this.id) {
                                        crntMsg = chatMessages[j];
                                        break;
                                    }
                                }
                                if (crntMsg.userId == crntUser.userId) {
                                    document.getElementById("msghead").innerHTML = crntMsg.body.substr(0, 15) + "...";
                                    document.getElementById("mine_popup").style.display = "block";
                                    crntMess = crntMsg;
                                }

                                else {
                                    document.getElementById("msgheadPrvt").innerHTML = crntMsg.body.substr(0, 15) + "...";
                                    document.getElementById("mine_popupPrvt").style.display = "block";
                                    crntMess = crntMsg;
                                }

                            });
                            
                            MsgFld.appendChild(par);
                            var timeFld = document.createElement("span");
                            timeFld.style.fontSize = "10px";
                            timeFld.innerText = chatMessages[j].creationTime.substring(11, 16);
                            timeFld.style.cssFloat = "right";
                            MsgFld.appendChild(timeFld);
                            //document.getElementById("messagefield").appendChild(par);b
                            document.getElementById("messagefield").appendChild(MsgFld);
                        }
                    }
                }
                $("#usrTxt").focus();                    

            });
        }


        function MsgDelete() {
            document.getElementById("mine_popup").style.display = "none";

            $.ajax({
                type: "DELETE",
                url: base_url + "Messages/" + crntMess.msgId,
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    ShowUsers();
                }
            });
        }


        function MsgEdit() {
            document.getElementById("mine_popup").style.display = "none";
            document.getElementById("usrTxt").value = crntMess.body;
            $("#sendBtn").css("display", "none");
            document.getElementById("updateMsg").style.display = "block";
        }


        $("#updateMsg").click(function () {
            crntMess.body = $("#usrTxt").val();
            $.ajax({
                type: "PUT",
                data: JSON.stringify(crntMess),
                url: base_url + "Messages/" + crntMess.msgId,
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    ShowUsers();
                }
            });
            $("#sendBtn").css("display", "block");
            document.getElementById("updateMsg").style.display = "none";
            $("#usrTxt").val("");
        });
              

        function MsgDeleteOne(CrntMsg) {
            document.getElementById("mine_popup").style.display = "none";

            CrntMsg.UserNotVisible = true;

            $.ajax({
                type: "PUT",
                data: JSON.stringify(CrntMsg),
                url: base_url + "Messages/" + CrntMsg.msgId,
                crossDomain: true,
                contentType: "application/json",
                success: function (data) {
                    ShowUsers();
                }
            });

        }


        function HidePopup(id) {
            document.getElementById(id).style.display = "none";
        }


        function PublicReply(crntMess, crntUser) {
            document.getElementById("mine_popupPrvt").style.display = "none";
            $("#usrTxt").val("");
            document.getElementById('MsgFld').innerHTML = document.getElementById(crntMess.msgId).innerText.substr(0, 20) + "...";
            document.getElementById('MsgFld').style.display = "block";       
            $("#usrTxt").focus();
            $('#PrsnlRplBtn').show();
            $('#CancelRplBtn').show();
            $('#sendBtn').hide();
        }


        $('#CancelRplBtn').click(function () {
            $('#PrsnlRplBtn').hide();
            $('#CancelRplBtn').hide();
            $('#sendBtn').show();
            document.getElementById('MsgFld').style.display = "none"; 
            $("#usrTxt").val("");
            $("#usrTxt").focus();
        });


        $('#PrsnlRplBtn').click(function () {

            if ($("#usrTxt").val() == "") { alert("Message can't be blank!"); }
            else {

                var userMessage = {
                    body: document.getElementById('MsgFld').innerText + $("#usrTxt").val(), creationTime: new Date(),
                    chatId: crntChatId, userId: crntUser.userId, isReply: true
                };
                $('#PrsnlRplBtn').hide();
                $('#CancelRplBtn').hide();
                $('#sendBtn').show();
                document.getElementById('MsgFld').innerHTML = ""; 
                document.getElementById('MsgFld').style.display = "none";
                $("#usrTxt").val("");

                $.ajax({
                    type: "POST",
                    data: JSON.stringify(userMessage),
                    url: base_url + "Messages/",
                    crossDomain: true,
                    contentType: "application/json",
                    success: function (data) {
                        $("#usrTxt").val("");
                        ShowUsers();
                    }
                });
            }

        });


        function PersonalReply(crntMess, crntUser) {

        }


        function ShowRegistration() {
            document.getElementById("regform").style.display = "block";
            document.getElementById("loginform").style.display = "none";

        }

        function SubmitForm() {
            var fields = $(".ss-item-required")
                .find("select, textarea, input").serializeArray();
            var fire = true;

            $.each(fields, function (i, field) {
                if (!field.value) {
                    alert(field.name + ' is required');
                    fire = false;
                }
            });
            console.log(fields);
            if (fire) {
                if (fields[2].value == fields[3].value) {
                    var user = { username: fields[0].value, email: fields[1].value, password: fields[2].value, usermessages: null, userchats: null };

                    $.ajax({
                        type: "POST",
                        data: JSON.stringify(user),
                        url: base_url + "users",
                        crossDomain: true,
                        contentType: "application/json",
                        success: function (data) {
                            crntUser = data;
                            $("#hp").html("User: " + "<b>" + crntUser.userName + "</b>");
                            $.each(fields, function (i, field) {
                                document.getElementById("field" + i).value = " ";
                            });
                            
                            
                            ShowChats();
                            document.getElementById("mainform").style.display = "block";
                            document.getElementById("regform").style.display = "none";

                            document.getElementById("loginform").style.display = "none";
                        }
                    });           

                }
                else {
                    alert("password doesn't match!");
                }
            }
        }

        function LoginUser() {
            var fire = true;
            for (var i = 0; i < 2; i++) {
                if (!document.getElementById("login"+i).value) {
                    alert(document.getElementById("login" + i).name + ' is  required');
                    var fire = false;
                }
            }   
            
            if (fire) {
                var url = base_url + 'users/' + document.getElementById("login0").value;
                var tempuser;
                $.get(url, function (object) {
                    tempuser = object;
                    if (tempuser.userId == -1 || tempuser.password != document.getElementById("login1").value) {
                        alert("wrong credentials!");
                    }
                    else {
                        crntUser = tempuser;

                        for (var i = 0; i < 2; i++) {
                            document.getElementById("login" + i).value = " ";
                        }
                        document.getElementById("loginform").style.display = "none";
                        ShowChats();
                        document.getElementById("mainform").style.display = "block";
                        $("#hp").html("User: " + "<b>" + crntUser.userName + "</b>");
                    }                    
                });
            }
        }

        function LeaveRegistration() {
            document.getElementById("regform").style.display = "none";
            document.getElementById("loginform").style.display = "block";
        }

        function LogOut() {
            crntUser = null;
            document.getElementById("mainform").style.display = "none";
            document.getElementById("loginform").style.display = "block";
        }
    </script>
</body>
</html>